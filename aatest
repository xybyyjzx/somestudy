// src/test/groovy/com/example/test/RealUniversalDslSpec.groovy
package com.example.test

import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest
import org.springframework.test.web.servlet.MockMvc
import spock.lang.Specification

import static groovy.json.JsonOutput.toJson
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*

@WebMvcTest
class RealUniversalDslSpec extends Specification {

    @Autowired MockMvc mockMvc

    def "执行所有 DSL 文件 - 真正可用的版本"() {
        setup:
        def dslFiles = new File("src/test/resources/api-tests")
                .listFiles()?.findAll { it.name.endsWith(".groovy") } ?: []

        expect:
        dslFiles.each { file ->
            println "\n=== 运行 DSL: ${file.name} ==="
            def binding = new Binding()
            binding.mockMvc = mockMvc
            binding.spec = this  // 关键：把当前 spec 实例传进去，让 DSL 能操作 mock
            binding.test = this.&runTest

            new GroovyShell(binding).evaluate(file)
        }
    }

    private void runTest(Closure config) {
        def scenario = new Scenario()
        config.delegate = scenario
        config.resolveStrategy = Closure.DELEGATE_FIRST
        config()

        // 动态加载 Controller（WebMvcTest 独有机制）
        if (scenario.controller) {
            def includeControllers = this.class.getAnnotation(WebMvcTest).includeControllers()
            if (!includeControllers*.value().flatten().contains(scenario.controller)) {
                // 只能通过重新创建上下文实现，接受这个小代价
                // 或者你全局 @WebMvcTest(includeControllers = [...所有Controller])，最简单
            }
        }

        def request = request(scenario.method, scenario.url)
                .contentType("application/json")
                .content(scenario.body ? toJson(scenario.body) : "")

        mockMvc.perform(request)
                .andDo(print())
                .andExpect(status().is(scenario.status))
                .andExpect(scenario.json ? content().json(toJson(scenario.json)) : everything())
    }
}

class Scenario {
    String method = "POST"
    String url
    def body
    int status = 200
    def json
    Class<?> controller
}
