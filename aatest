// src/test/groovy/com/example/test/BaseMockMvcSpec.groovy
package com.example.test

import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest
import org.springframework.test.web.servlet.MockMvc
import spock.lang.Specification

import static org.springframework.http.MediaType.APPLICATION_JSON
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*
import static groovy.json.JsonOutput.toJson

@WebMvcTest  // 只加载 Web 层
class BaseMockMvcSpec extends Specification {

    @Autowired
    MockMvc mockMvc

    // DSL 入口（简化版，不再手动注册 SpringBean）
    def api(Closure dslClosure) {
        def dsl = new ApiTestDsl()
        dslClosure.delegate = dsl
        dslClosure.resolveStrategy = Closure.DELEGATE_FIRST
        dslClosure.call()
        
        // 执行所有测试场景
        dsl.scenarios.each { scenario ->
            performTest(scenario)
        }
    }

    private void performTest(TestScenario scenario) {
        def requestBuilder = request(scenario.method, scenario.url)
                .contentType(APPLICATION_JSON)
        
        if (scenario.requestBody) {
            requestBuilder.content(toJson(scenario.requestBody))
        }
        
        mockMvc.perform(requestBuilder)
                .andExpect(status().is(scenario.expectedStatus))
                .andExpect(content().json(toJson(scenario.expectedJson)))
                .andDo(print())
    }
}
